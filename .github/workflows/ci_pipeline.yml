name: CI pipeline

on:
  push:
    branches:
      - main

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Detect tests
        id: detect_tests
        run: |
          TEST_RESULTS=$(python scripts/test_detector.py)
          echo "Test Results:"
          echo "$TEST_RESULTS"
          echo "::set-output name=test_results::$TEST_RESULTS"

      - name: Loop over test cases
        run: |
          IFS=$','
          for TEST_CASE in ${{ steps.detect_tests.outputs.test_results }}; do
            TEST_NAME=$(echo "$TEST_CASE" | cut -d ':' -f 1)
            TEST_VALUE=$(echo "$TEST_CASE" | cut -d ',' -f 2)
            echo "Running tests for $TEST_NAME with value $TEST_VALUE"
            python scripts/builder.py "${TEST_NAME}.cpp"
            python scripts/tester.py "${TEST_NAME}.cpp" "$TEST_VALUE"
          done
